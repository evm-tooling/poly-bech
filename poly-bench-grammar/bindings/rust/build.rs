//! Build script for tree-sitter-polybench
//!
//! This compiles the Tree-sitter parser and custom scanner.
//! Also generates queries/injections.scm from the supported languages list.
//!
//! Note: The parser.c file must be generated first by running:
//!   cd poly-bench-grammar && npm install && npm run generate

fn main() {
    generate_injections();
    build_parser();
}

fn generate_injections() {
    let manifest_dir = std::env::var("CARGO_MANIFEST_DIR").unwrap();
    let manifest_path = std::path::Path::new(&manifest_dir);
    let queries_dir = manifest_path.join("queries");
    let out_path = queries_dir.join("injections.scm");

    let mut out = String::from(
        "; Injection queries for embedded languages in poly-bench
; AUTO-GENERATED by build.rs - do not edit manually
; Add new languages in build.rs when adding a runtime.

",
    );

    // (display_name, tags, tree_sitter_injection_name, use_paren_code_block_for_import)
    let languages: &[(&str, &[&str], &str, bool)] = &[
        ("Go", &["go"], "go", true),
        ("TypeScript", &["ts", "typescript"], "typescript", false),
        ("Rust", &["rust"], "rust", false),
        ("Python", &["python", "py"], "python", false),
        ("C#", &["csharp", "cs"], "c_sharp", false),
    ];

    for (name, tags, tree_sitter_name, use_paren_code_block) in languages {
        let tag_pred = if tags.len() == 1 {
            format!(r#"(#eq? @_lang "{}")"#, tags[0])
        } else {
            let quoted: Vec<_> = tags.iter().map(|t| format!("\"{}\"", t)).collect();
            format!(r#"(#any-of? @_lang {})"#, quoted.join(" "))
        };

        let set_injection = if *tree_sitter_name != tags[0] || tags.len() > 1 {
            format!(
                r#"
  (#set! injection.language "{}")"#,
                tree_sitter_name
            )
        } else {
            String::new()
        };

        let import_block = if *use_paren_code_block {
            "(paren_code_block\n        (embedded_code) @injection.content)"
        } else {
            "(code_block\n        (embedded_code) @injection.content)"
        };

        out.push_str(&format!(
            "; ============================================================
; {} injections
; ============================================================

; Setup block with {} language
(setup_block
  language: (language_tag) @_lang
  (setup_body
    (import_section
      {}))
  {}{})

(setup_block
  language: (language_tag) @_lang
  (setup_body
    (declare_section
      (code_block
        (embedded_code) @injection.content)))
  {}{})

(setup_block
  language: (language_tag) @_lang
  (setup_body
    (init_section
      (code_block
        (embedded_code) @injection.content)))
  {}{})

(setup_block
  language: (language_tag) @_lang
  (setup_body
    (helpers_section
      (code_block
        (embedded_code) @injection.content)))
  {}{})

; Language implementation with {}
(language_implementation
  language: (language_tag) @_lang
  (code_block
    (embedded_code) @injection.content)
  {}{})

; Hook with {}
(hook_flat
  language: (language_tag) @_lang
  (code_block
    (embedded_code) @injection.content)
  {}{})

",
            name,
            name,
            import_block,
            tag_pred,
            set_injection,
            tag_pred,
            set_injection,
            tag_pred,
            set_injection,
            tag_pred,
            set_injection,
            name,
            tag_pred,
            set_injection,
            name,
            tag_pred,
            set_injection,
        ));
    }

    out.push_str(
        "; ============================================================
; Inline code injections (single-line expressions)
; ============================================================

",
    );

    for (name, tags, tree_sitter_name, _) in languages {
        let tag_pred = if tags.len() == 1 {
            format!(r#"(#eq? @_lang "{}")"#, tags[0])
        } else {
            let quoted: Vec<_> = tags.iter().map(|t| format!("\"{}\"", t)).collect();
            format!(r#"(#any-of? @_lang {})"#, quoted.join(" "))
        };

        out.push_str(&format!(
            "; {} inline code
(language_implementation
  language: (language_tag) @_lang
  (inline_code) @injection.content
  {}
  (#set! injection.language \"{}\"))

",
            name, tag_pred, tree_sitter_name,
        ));
    }

    out.push_str(
        "; Set injection language for Go blocks (fallback)
((embedded_code) @injection.content
  (#set! injection.language \"go\")
  (#match? @injection.content \"\"))

",
    );

    std::fs::write(&out_path, out).expect("Failed to write injections.scm");
    println!("cargo:rerun-if-changed=bindings/rust/build.rs");
}

fn build_parser() {
    let manifest_dir = std::env::var("CARGO_MANIFEST_DIR").unwrap();
    let manifest_path = std::path::Path::new(&manifest_dir);
    let src_dir = manifest_path.join("src");

    let parser_path = src_dir.join("parser.c");
    if !parser_path.exists() {
        eprintln!("=======================================================");
        eprintln!("ERROR: src/parser.c not found!");
        eprintln!("");
        eprintln!("The Tree-sitter grammar needs to be generated first.");
        eprintln!("Run the following commands:");
        eprintln!("");
        eprintln!("  cd poly-bench-grammar");
        eprintln!("  npm install");
        eprintln!("  npm run generate");
        eprintln!("");
        eprintln!("Or use: make grammar");
        eprintln!("=======================================================");
        std::process::exit(1);
    }

    let mut c_config = cc::Build::new();
    c_config.std("c11").include(&src_dir);

    // Enable UTF-8 source encoding for MSVC
    #[cfg(target_env = "msvc")]
    c_config.flag("-utf-8");

    // Compile the generated parser
    c_config.file(&parser_path);
    println!("cargo:rerun-if-changed={}", parser_path.to_str().unwrap());

    // Compile the custom scanner
    let scanner_path = src_dir.join("scanner.c");
    if scanner_path.exists() {
        c_config.file(&scanner_path);
        println!("cargo:rerun-if-changed={}", scanner_path.to_str().unwrap());
    }

    c_config.compile("tree-sitter-polybench");
}
