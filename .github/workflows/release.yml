name: Release

on:
  issue_comment:
    types: [created, edited]

jobs:
  release:
    # Only run if the comment contains /release on a PR
    if: ${{ contains(github.event.comment.body, '/release')
            && github.event.issue.pull_request }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Check PR is open
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            if (pr.data.state !== 'open') {
              core.setFailed('PR is not open');
              return;
            }

      - name: Classify PR changes
        id: changes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              per_page: 100
            });

            const docsChanged = files.some(f => f.filename.startsWith('docs/'));
            const codeChanged = files.some(f => !f.filename.startsWith('docs/'));

            // Check if PR title indicates no VSCode extension publish
            const skipVscode = pr.data.title.toLowerCase().includes('no vscode');

            core.setOutput('docs_changed', String(docsChanged));
            core.setOutput('code_changed', String(codeChanged));
            core.setOutput('skip_vscode', String(skipVscode));
            console.log(`docs_changed=${docsChanged}, code_changed=${codeChanged}, skip_vscode=${skipVscode}`);

      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fast forward merge
        uses: sequoia-pgp/fast-forward@v1
        with:
          merge: true
          comment: always

      - name: Set up Node.js
        if: ${{ steps.changes.outputs.code_changed == 'true' && steps.changes.outputs.skip_vscode != 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Tree-sitter WASM for extension
        if: ${{ steps.changes.outputs.code_changed == 'true' && steps.changes.outputs.skip_vscode != 'true' }}
        run: make grammar-wasm

      - name: Publish VSCode extension
        if: ${{ steps.changes.outputs.code_changed == 'true' && steps.changes.outputs.skip_vscode != 'true' }}
        working-directory: extensions/vscode
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          npm ci
          VERSION=$(node -p "require('./package.json').version")
          echo "Publishing version $VERSION"
          npm run publish:ci -- VERSION=$VERSION

      - name: Publish prerelease as latest
        if: ${{ steps.changes.outputs.code_changed == 'true' }}
        id: publish_release
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });

            // Find the latest prerelease
            const prerelease = releases.data.find(r => r.prerelease);

            if (!prerelease) {
              console.log('No prerelease found, skipping publish');
              return;
            }

            // Publish it as the latest release
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: prerelease.id,
              prerelease: false,
              make_latest: 'true'
            });

            core.setOutput('tag', prerelease.tag_name);
            core.setOutput('url', prerelease.html_url);
            console.log(`Published release: ${prerelease.tag_name}`);

      - name: Comment success
        uses: actions/github-script@v7
        env:
          DOCS_CHANGED: ${{ steps.changes.outputs.docs_changed }}
          CODE_CHANGED: ${{ steps.changes.outputs.code_changed }}
          SKIP_VSCODE: ${{ steps.changes.outputs.skip_vscode }}
          RELEASE_TAG: ${{ steps.publish_release.outputs.tag }}
          RELEASE_URL: ${{ steps.publish_release.outputs.url }}
        with:
          script: |
            const docsChanged = process.env.DOCS_CHANGED === 'true';
            const codeChanged = process.env.CODE_CHANGED === 'true';
            const skipVscode = process.env.SKIP_VSCODE === 'true';
            const releaseTag = process.env.RELEASE_TAG;
            const releaseUrl = process.env.RELEASE_URL;

            let message = 'âœ… Fast-forward merge complete!';

            if (docsChanged && !codeChanged) {
              message = 'ðŸ“š Docs-only release complete: merged to `production` for Vercel deploy. No binary/tag promotion run.';
            } else if (!docsChanged && codeChanged) {
              const vscodeNote = skipVscode ? ' (VSCode extension publish skipped)' : '';
              message = releaseTag && releaseUrl
                ? `ðŸš€ Code release complete: published [${releaseTag}](${releaseUrl})${vscodeNote}.`
                : `ðŸš€ Code release complete: fast-forward merged and code release steps ran${vscodeNote}.`;
            } else if (docsChanged && codeChanged) {
              const vscodeNote = skipVscode ? ' (VSCode extension publish skipped)' : '';
              message = releaseTag && releaseUrl
                ? `ðŸš€ Mixed release complete: docs deployed and [${releaseTag}](${releaseUrl}) published${vscodeNote}.`
                : `ðŸš€ Mixed release complete: docs deployed and code release steps ran${vscodeNote}.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
