use std::charting

suite example {
    description: "Fibonacci benchmark - no external dependencies"
    warmup: 10
    baseline: "go"
    targetTime: 2000ms
    mode: "auto"
    count: 2
    cvThreshold: 5

    setup go {
        helpers {
            func fibGo(data []byte) []byte {
                n := int(data[0])
                if n <= 1 {
                    return []byte{byte(n)}
                }
                a, b := 0, 1
                for i := 2; i <= n; i++ {
                    a, b = b, a+b
                }
                return []byte{byte(b & 0xFF)}
            }
        }
    }

    setup ts {
        helpers {
            function fibTs(data: Uint8Array): Uint8Array {
                const n = data[0]
                if (n <= 1) return new Uint8Array([n])
                let a = 0, b = 1
                for (let i = 2; i <= n; i++) {
                    [a, b] = [b, a + b]
                }
                return new Uint8Array([b & 0xFF])
            }
        }
    }

    setup c {
        import {
            #include <stdint.h>
        }
        helpers {
            static unsigned char* fib_c(unsigned char* data) {
                int n = data[0];
                if (n <= 1) {
                    data[0] = (unsigned char)n;
                    return data;
                }
                int a = 0, b = 1;
                for (int i = 2; i <= n; i++) {
                    int next = a + b;
                    a = b;
                    b = next;
                }
                data[0] = (unsigned char)(b & 0xFF);
                return data;
            }
        }
    }

    fixture n20 {
        hex: "14"
    }

    fixture n30 {
        hex: "1e"
    }

    fixture n40 {
        hex: "28"
    }

    fixture n50 {
        hex: "32"
    }

    fixture n60 {
        hex: "3C"
    }

    fixture n70 {
        hex: "46"
    }

    bench fib20 {
        go: fibGo(n20)
        ts: fibTs(n20)
        c: fib_c(n20)
    }

    bench fib30 {
        go: fibGo(n30)
        ts: fibTs(n30)
        c: fib_c(n30)
    }

    bench fib40 {
        go: fibGo(n40)
        ts: fibTs(n40)
        c: fib_c(n40)
    }

    bench fib50 {
        go: fibGo(n50)
        ts: fibTs(n50)
        c: fib_c(n50)
    }

    bench fib60 {
        go: fibGo(n60)
        ts: fibTs(n60)
        c: fib_c(n60)
    }

    bench fib70 {
        go: fibGo(n70)
        ts: fibTs(n70)
        c: fib_c(n70)
    }

    after {
        charting.drawSpeedupChart(
            title: "Fibonacci Speedup",
            description: "Relative performance vs baseline",
            output: "fib-speedup.svg",
            baseline: "go",
            sortBy: "name",
            sortOrder: "asc",
            legendPosition: "top-left"
        )

        charting.drawTable(
            title: "Fibonacci Results Table",
            description: "Raw timings and winners",
            output: "fib-table.svg",
            sortBy: "name",
            sortOrder: "asc"
        )
    }
}
